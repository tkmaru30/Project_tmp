# GitHub Actions プルリクエスト自動マージ設定

このディレクトリには、GitHub Actionsを使用してプルリクエストを自動的にマージするためのワークフローが含まれています。

## 📁 ファイル構成

- `auto-merge-pr.yml` - 基本的な自動マージワークフロー（修正済み）
- `secure-auto-merge-pr.yml` - セキュリティ強化版の自動マージワークフロー（修正済み）
- `simple-auto-merge-pr.yml` - シンプルで堅牢な自動マージワークフロー（新規）
- `pr-auto-merge-settings.yml` - 設定管理用ワークフロー
- `auto-merge-config.json` - 自動マージの設定ファイル

## 🚀 セットアップ手順

### 1. リポジトリの設定

1. リポジトリの設定で「Actions」を有効化
2. ブランチ保護ルールを設定（推奨）：
   - `main`/`master`ブランチにブランチ保護ルールを適用
   - 必須のステータスチェックを設定
   - レビューの要求を設定

### 2. 権限の設定

リポジトリの設定で以下の権限を確認：
- Actions: 読み取り・書き込み権限
- Pull requests: 書き込み権限
- Contents: 書き込み権限

### 3. 設定ファイルのカスタマイズ

`.github/auto-merge-config.json`を編集して設定をカスタマイズ：

```json
{
  "required_reviews": 1,
  "auto_merge_labels": "auto-merge,ready-to-merge",
  "exclude_authors": "bot-user,automated-user",
  "merge_method": "squash",
  "delete_branch_after_merge": true,
  "require_checks_to_pass": true,
  "required_status_checks": []
}
```

## 🔧 使用方法

### 基本的な使用方法

1. プルリクエストを作成
2. 以下のいずれかのラベルを追加：
   - `auto-merge`
   - `ready-to-merge`
3. 必要なレビューを取得
4. すべてのチェックが成功するのを待つ
5. 自動的にマージされる

### セキュリティ機能（secure-auto-merge-pr.yml）

- **ブランチ保護**: メインブランチへの直接プッシュを検出
- **ファイル検証**: 機密ファイルの変更を検出
- **コミットメッセージ検証**: 機密情報の漏洩を防止
- **作者除外**: 特定の作者を自動マージから除外

## 📋 ワークフローの種類

### 1. auto-merge-pr.yml（修正済み）
- 基本的な自動マージ機能
- ラベルベースのトリガー
- レビュー要求の確認
- チェックステータスの確認
- エラーハンドリング強化

### 2. secure-auto-merge-pr.yml（修正済み）
- セキュリティ強化版
- ファイル変更の検証
- ブランチ保護の確認
- リスクレベルの評価
- GitHub CLIの自動インストール

### 3. simple-auto-merge-pr.yml（新規）
- シンプルで堅牢な設計
- 最小限の依存関係
- エラー耐性の向上
- デバッグ情報の充実

### 4. pr-auto-merge-settings.yml
- 設定管理用
- 手動での設定変更
- 設定の確認と更新

## ⚙️ 設定オプション

| 設定項目 | 説明 | デフォルト値 |
|---------|------|-------------|
| `required_reviews` | 必要なレビュー数 | 1 |
| `auto_merge_labels` | 自動マージ用ラベル（カンマ区切り） | "auto-merge,ready-to-merge" |
| `exclude_authors` | 除外する作者（カンマ区切り） | "" |
| `merge_method` | マージ方法（squash/merge/rebase） | "squash" |
| `delete_branch_after_merge` | マージ後にブランチを削除 | true |

## 🔒 セキュリティ考慮事項

1. **最小権限の原則**: 必要最小限の権限のみを付与
2. **ブランチ保護**: メインブランチへの直接プッシュを防止
3. **ファイル検証**: 機密ファイルの変更を検出
4. **レビュー要求**: 必須レビューの設定
5. **チェック要求**: 必須ステータスチェックの設定

## 🚨 トラブルシューティング

### よくある問題

1. **自動マージが実行されない**
   - ラベルが正しく設定されているか確認
   - 必要なレビュー数が満たされているか確認
   - すべてのチェックが成功しているか確認

2. **権限エラーが発生する**
   - リポジトリの権限設定を確認
   - GitHub Actionsの権限を確認

3. **セキュリティチェックで失敗する**
   - 機密ファイルが含まれていないか確認
   - コミットメッセージに機密情報が含まれていないか確認

### ログの確認

GitHub Actionsのログで詳細な実行状況を確認できます：
1. リポジトリの「Actions」タブを開く
2. 該当するワークフロー実行をクリック
3. 各ステップのログを確認

## 📞 サポート

問題が発生した場合は、以下を確認してください：
1. GitHub Actionsのログ
2. リポジトリの権限設定
3. ブランチ保護ルールの設定
4. 設定ファイルの内容

## 🔄 更新履歴

- v1.0.0: 基本的な自動マージ機能を実装
- v1.1.0: セキュリティ機能を追加
- v1.2.0: 設定管理機能を追加
- v1.3.0: セキュリティバリデーションのエラーを修正
  - GitHub CLIの自動インストールを追加
  - エラーハンドリングを強化
  - デバッグ情報を充実
  - シンプル版ワークフローを追加