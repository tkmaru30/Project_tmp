name: Auto Merge Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

# å¿…è¦ãªæ¨©é™ã‚’æ˜ç¤ºçš„ã«è¨­å®š
permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read

jobs:
  auto-merge:
    # ç‰¹å®šã®æ¡ä»¶ã‚’æº€ãŸã™å ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      github.event.pull_request.draft == false &&
      github.event.pull_request.mergeable == true &&
      (github.event.action == 'opened' || 
       github.event.action == 'synchronize' || 
       github.event.action == 'reopened' ||
       (github.event.action == 'submitted' && github.event.review.state == 'approved') ||
       (github.event.action == 'completed' && github.event.check_suite.conclusion == 'success'))
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Get PR information
        id: pr-info
        run: |
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è©³ç´°ã‚’å–å¾—
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "pr_author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ©ãƒ™ãƒ«ã‚’ç¢ºèª
          LABELS=$(gh pr view $PR_NUMBER --json labels --jq '.labels[].name' 2>/dev/null | tr '\n' ',' | sed 's/,$//' || echo "")
          echo "pr_labels=$LABELS" >> $GITHUB_OUTPUT

      - name: Check auto-merge conditions
        id: check-conditions
        run: |
          # è‡ªå‹•ãƒãƒ¼ã‚¸ã®æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
          AUTO_MERGE_LABEL="auto-merge"
          READY_TO_MERGE_LABEL="ready-to-merge"
          PR_LABELS="${{ steps.pr-info.outputs.pr_labels }}"
          
          # ãƒ©ãƒ™ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          if echo "$PR_LABELS" | grep -q "$AUTO_MERGE_LABEL\|$READY_TO_MERGE_LABEL"; then
            echo "has_auto_merge_label=true" >> $GITHUB_OUTPUT
            echo "âœ… Auto-merge label found"
          else
            echo "has_auto_merge_label=false" >> $GITHUB_OUTPUT
            echo "âŒ No auto-merge label found"
          fi
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
          REVIEWS=$(gh pr view ${{ steps.pr-info.outputs.pr_number }} --json reviews --jq '.reviews[] | select(.state == "APPROVED") | .author.login' 2>/dev/null | sort | uniq || echo "")
          REVIEW_COUNT=$(echo "$REVIEWS" | wc -l)
          
          echo "review_count=$REVIEW_COUNT" >> $GITHUB_OUTPUT
          echo "approved_reviewers=$REVIEWS" >> $GITHUB_OUTPUT
          
          # å¿…è¦ãªãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ï¼ˆè¨­å®šå¯èƒ½ï¼‰
          REQUIRED_REVIEWS=${REQUIRED_REVIEWS:-1}
          echo "required_reviews=$REQUIRED_REVIEWS" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Reviews: $REVIEW_COUNT/$REQUIRED_REVIEWS"
          
          # ãƒã‚§ãƒƒã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
          CHECKS=$(gh pr checks ${{ steps.pr-info.outputs.pr_number }} --json status,conclusion --jq '.[] | select(.status == "completed") | .conclusion' 2>/dev/null || echo "")
          FAILED_CHECKS=$(echo "$CHECKS" | grep -v "success" | wc -l)
          
          echo "failed_checks=$FAILED_CHECKS" >> $GITHUB_OUTPUT
          echo "ğŸ” Failed checks: $FAILED_CHECKS"
          
          # æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          HAS_LABEL="${{ steps.pr-info.outputs.has_auto_merge_label }}"
          if [ "$HAS_LABEL" = "true" ] && 
             [ "$REVIEW_COUNT" -ge "$REQUIRED_REVIEWS" ] && 
             [ "$FAILED_CHECKS" -eq 0 ]; then
            echo "can_merge=true" >> $GITHUB_OUTPUT
            echo "âœ… All conditions met for auto-merge"
          else
            echo "can_merge=false" >> $GITHUB_OUTPUT
            echo "âŒ Conditions not met for auto-merge"
          fi

      - name: Wait for checks to complete
        if: steps.check-conditions.outputs.can_merge == 'true'
        run: |
          echo "Waiting for all checks to complete..."
          gh pr checks ${{ steps.pr-info.outputs.pr_number }} --watch --exit-status

      - name: Auto merge PR
        if: steps.check-conditions.outputs.can_merge == 'true'
        run: |
          PR_NUMBER=${{ steps.pr-info.outputs.pr_number }}
          
          echo "ğŸš€ Auto-merging PR #$PR_NUMBER"
          echo "Title: ${{ steps.pr-info.outputs.pr_title }}"
          echo "Author: ${{ steps.pr-info.outputs.pr_author }}"
          echo "Approved by: ${{ steps.check-conditions.outputs.approved_reviewers }}"
          
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒãƒ¼ã‚¸
          gh pr merge $PR_NUMBER --squash --delete-branch --subject "Auto-merge: ${{ steps.pr-info.outputs.pr_title }}"
          
          echo "âœ… Successfully merged PR #$PR_NUMBER"

      - name: Comment on PR
        if: steps.check-conditions.outputs.can_merge == 'false'
        run: |
          PR_NUMBER=${{ steps.pr-info.outputs.pr_number }}
          
          # æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ãªã„å ´åˆã®ã‚³ãƒ¡ãƒ³ãƒˆ
          COMMENT="ğŸ¤– **Auto-merge check failed**\n\n"
          COMMENT+="**Current status:**\n"
          COMMENT+="- Auto-merge label: ${{ steps.check-conditions.outputs.has_auto_merge_label }}\n"
          COMMENT+="- Reviews: ${{ steps.check-conditions.outputs.review_count }}/${{ steps.check-conditions.outputs.required_reviews }}\n"
          COMMENT+="- Failed checks: ${{ steps.check-conditions.outputs.failed_checks }}\n\n"
          COMMENT+="**To enable auto-merge, please:**\n"
          COMMENT+="1. Add \`auto-merge\` or \`ready-to-merge\` label\n"
          COMMENT+="2. Ensure all required reviews are approved\n"
          COMMENT+="3. Make sure all checks pass\n"
          
          gh pr comment $PR_NUMBER --body "$COMMENT"

      - name: Notify on merge
        if: steps.check-conditions.outputs.can_merge == 'true'
        run: |
          echo "ğŸ‰ PR #${{ steps.pr-info.outputs.pr_number }} has been automatically merged!"
          # ã“ã“ã§Slacké€šçŸ¥ã‚„ãã®ä»–ã®é€šçŸ¥ã‚’è¿½åŠ ã§ãã¾ã™